<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VAPECOIN â€¢ Valor de Canje</title>

<style>
  :root{
    --pv-blue:#0b76ff;
    --pv-blue-dark:#08338f;
    --bg:#f6f8fc;
    --card:#ffffff;
    --border:#e9eef5;
    --text:#203047;
    --muted:#6f7f96;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:transparent;}
  .wrap{display:flex;justify-content:center;padding:14px;}
  .card{
    width:100%;
    max-width:540px; /* mÃ¡s compacto */
    background:var(--card);
    border-radius:18px;
    border:1px solid var(--border);
    box-shadow:0 10px 24px rgba(0,0,0,.10);
    overflow:hidden;
  }

  /* Header wallet-style */
  .top{
    background:linear-gradient(135deg,var(--pv-blue) 0%,var(--pv-blue-dark) 100%);
    color:#fff;
    padding:16px 16px 14px;
    display:flex;
    align-items:flex-start;
    gap:12px;
  }
  .logo{
    width:48px;height:48px;border-radius:50%;
    background:rgba(0,0,0,.22);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:24px;
    flex:0 0 auto;
    margin-top:2px;
  }
  .h-left{min-width:0;}
  .title{font-weight:900;font-size:20px;line-height:1.1;}
  .subtitle{font-size:13px;opacity:.9;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

  .h-right{margin-left:auto;text-align:right;}
  .price-main{font-weight:900;font-size:20px;line-height:1.15;}
  .price-sub{font-size:12.5px;opacity:.92;margin-top:6px;}
  .chip{
    display:inline-flex;align-items:center;gap:6px;
    margin-top:8px;
    font-size:12px;font-weight:800;
    padding:6px 10px;border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.18);
  }
  .chip .dot{width:6px;height:6px;border-radius:99px;background:#fff;opacity:.85;}

  .mid{padding:12px 14px 10px;}
  .chart-wrap{
    background:var(--bg);
    border:1px solid var(--border);
    border-radius:16px;
    padding:10px 10px 8px;
  }

  /* Tabs */
  .tabs{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:8px 0 10px;
    flex-wrap:wrap;
  }
  .tab{
    padding:7px 12px;
    border-radius:999px;
    background:#eef2f7;
    color:#607089;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
    user-select:none;
    line-height:1;
  }
  .tab.active{
    background:rgba(0,0,0,.72);
    color:#fff;
  }

  svg{width:100%;height:315px;display:block;}

  /* Stats row */
  .stats{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:8px;
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid var(--border);
  }
  .stat{
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 10px;
    text-align:center;
  }
  .stat .k{font-size:12px;color:var(--muted);font-weight:800;}
  .stat .v{margin-top:6px;font-size:14px;color:var(--text);font-weight:900;}
  .stat .s{margin-top:2px;font-size:12px;color:var(--muted);}

  .footer{
    padding:10px 14px 14px;
    font-size:12px;
    color:var(--muted);
  }
  .footer strong{color:#2b3445;}

  @media (max-width:420px){
    svg{height:290px;}
    .price-main{font-size:18px;}
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="top">
      <div class="logo">V</div>

      <div class="h-left">
        <div class="title">VAPECOIN</div>
        <div class="subtitle" id="label">Valor de canje interno (oficial)</div>
      </div>

      <div class="h-right">
        <div class="price-main" id="mainPrice">â€”</div>
        <div class="price-sub" id="subPrice">Valor oficial del dÃ­a â€¢ USD</div>

        <div class="chip" id="chipChange" style="display:none;">
          <span class="dot"></span>
          <span id="chipText">â€”</span>
        </div>

        <div class="price-sub" id="lastUpdate">Ãšltima variaciÃ³n: â€”</div>
      </div>
    </div>

    <div class="mid">
      <div class="chart-wrap">

        <div class="tabs">
          <div class="tab" data-range="24H">24H</div>
          <div class="tab" data-range="7D">7D</div>
          <div class="tab active" data-range="1M">1M</div>
          <div class="tab" data-range="1Y">1Y</div>
          <div class="tab" data-range="MAX">MAX</div>
        </div>

        <svg id="svg" viewBox="0 0 960 315" preserveAspectRatio="none">
          <defs>
            <linearGradient id="fillGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="rgba(11,118,255,.22)"></stop>
              <stop offset="100%" stop-color="rgba(11,118,255,.04)"></stop>
            </linearGradient>
          </defs>

          <g id="grid"></g>
          <g id="labels"></g>

          <path id="area" fill="url(#fillGrad)"></path>
          <path id="line" fill="none" stroke="rgba(11,118,255,1)" stroke-width="4"
                stroke-linecap="round" stroke-linejoin="round"></path>
          <circle id="dot" r="6" fill="rgba(11,118,255,1)"></circle>
        </svg>

        <div class="stats">
          <div class="stat">
            <div class="k">Volumen 24h (sim.)</div>
            <div class="v" id="vol24">â€”</div>
            <div class="s" id="vol24s">segÃºn historial</div>
          </div>
          <div class="stat">
            <div class="k">Cap. Mercado (sim.)</div>
            <div class="v" id="mcap">â€”</div>
            <div class="s" id="mcapS">segÃºn historial</div>
          </div>
          <div class="stat">
            <div class="k">Liquidez (sim.)</div>
            <div class="v" id="liq">â€”</div>
            <div class="s" id="liqS">segÃºn historial</div>
          </div>
        </div>

      </div>
    </div>

    <div class="footer">
      <div><strong>*</strong> <span id="note">â€”</span></div>
      <div style="margin-top:6px">Actualizado: <span id="updatedAt">â€”</span></div>
    </div>

  </div>
</div>

<script>
/* ====== URLs ====== */
const RATE_URL = "https://peruvapea-svg.github.io/vapecoin-widget/vapecoin-rate.json";
const HISTORY_URL = "https://peruvapea-svg.github.io/vapecoin-widget/history.json";

/* ====== SimulaciÃ³n (solo en index) ======
   Puedes ajustar estos 3 nÃºmeros cuando quieras:
*/
const INTERNAL_SUPPLY = 5_000_000; // cap mercado simulado = precio * supply
const LIQUIDITY_PCT = 0.018;       // liquidez simulada = marketcap * pct
const VOLUME_FACTOR = 120_000;     // escala volumen 24h segÃºn movimiento diario

let currentRange = "1M";  // default al cargar: 1M
let history = [];
let cfg = null;

/* ====== Elements ====== */
const elLabel = document.getElementById("label");
const elMain  = document.getElementById("mainPrice");
const elSub   = document.getElementById("subPrice");
const elChip  = document.getElementById("chipChange");
const elChipT = document.getElementById("chipText");
const elLast  = document.getElementById("lastUpdate");
const elUpd   = document.getElementById("updatedAt");
const elNote  = document.getElementById("note");

const elVol   = document.getElementById("vol24");
const elVolS  = document.getElementById("vol24s");
const elMcap  = document.getElementById("mcap");
const elLiq   = document.getElementById("liq");

const svgGrid   = document.getElementById("grid");
const svgLabels = document.getElementById("labels");
const pathLine  = document.getElementById("line");
const pathArea  = document.getElementById("area");
const dot       = document.getElementById("dot");

/* ====== Helpers ====== */
function fmtUSD(v){
  return new Intl.NumberFormat("en-US",{
    style:"currency",
    currency:"USD",
    maximumFractionDigits:6
  }).format(v);
}
function fmtUSD0(v){
  return new Intl.NumberFormat("en-US",{
    style:"currency",
    currency:"USD",
    maximumFractionDigits:0
  }).format(v);
}
function pct(from, to){
  if(!from || from === 0) return 0;
  return ((to - from) / from) * 100;
}
function parseDate(s){
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
}
function daysBetween(a,b){
  const ms = 24*60*60*1000;
  return Math.round((b - a) / ms);
}
function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

function addText(parent, x, y, text, size=12, color="rgba(111,127,150,1)", anchor="start"){
  const t = document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x", x);
  t.setAttribute("y", y);
  t.setAttribute("fill", color);
  t.setAttribute("font-size", String(size));
  t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Arial");
  t.setAttribute("text-anchor", anchor);
  parent.appendChild(t);
  t.textContent = text;
}
function addLine(parent, x1,y1,x2,y2, color="rgba(120,140,165,.22)", width=1){
  const l = document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1", x1); l.setAttribute("y1", y1);
  l.setAttribute("x2", x2); l.setAttribute("y2", y2);
  l.setAttribute("stroke", color);
  l.setAttribute("stroke-width", String(width));
  parent.appendChild(l);
}

/* ====== Range slicing ====== */
function sliceForRange(data){
  if(data.length === 0) return data;
  if(currentRange === "24H") return data.slice(-2);
  if(currentRange === "7D")  return data.slice(-7);
  if(currentRange === "1M")  return data.slice(-30);
  if(currentRange === "1Y")  return data.slice(-365);
  return data;
}
function safePoints(points){
  if(points.length >= 2) return points;
  if(history.length >= 2) return history.slice(-2);
  if(history.length === 1) return [history[0], history[0]];
  return [];
}

/* ====== Smooth curve (Catmull-Rom to Bezier) ====== */
function smoothPath(pts){
  if(pts.length < 2) return "";
  if(pts.length === 2){
    return `M ${pts[0].x} ${pts[0].y} L ${pts[1].x} ${pts[1].y}`;
  }
  const d = [];
  d.push(`M ${pts[0].x} ${pts[0].y}`);
  for(let i=0;i<pts.length-1;i++){
    const p0 = pts[i-1] || pts[i];
    const p1 = pts[i];
    const p2 = pts[i+1];
    const p3 = pts[i+2] || p2;

    const c1x = p1.x + (p2.x - p0.x) / 6;
    const c1y = p1.y + (p2.y - p0.y) / 6;
    const c2x = p2.x - (p3.x - p1.x) / 6;
    const c2y = p2.y - (p3.y - p1.y) / 6;

    d.push(`C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2.x} ${p2.y}`);
  }
  return d.join(" ");
}

/* ====== Draw ====== */
function drawChart(pointsRaw){
  const points = safePoints(pointsRaw);
  if(points.length < 2){
    clearNode(svgGrid); clearNode(svgLabels);
    pathLine.setAttribute("d", "");
    pathArea.setAttribute("d", "");
    dot.setAttribute("cx","0"); dot.setAttribute("cy","0");
    return;
  }

  const W = 960, H = 315;
  const padL = 72, padR = 26, padT = 14, padB = 62;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const values = points.map(p => p.value);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const span = (maxV - minV) || (maxV*0.001) || 1;

  const xAt = (i) => padL + plotW * (i/(points.length-1 || 1));
  const yAt = (v) => padT + plotH - plotH * ((v - minV)/span);

  clearNode(svgGrid);
  clearNode(svgLabels);

  // Grid horizontal + labels Y
  const levels = 5;
  for(let k=0;k<levels;k++){
    const t = k/(levels-1);
    const y = padT + plotH*t;
    addLine(svgGrid, padL, y, W-padR, y, "rgba(120,140,165,.22)", 1);
    const v = (maxV - span*t);
    addText(svgLabels, padL-12, y+4, fmtUSD(v), 12, "rgba(111,127,150,1)", "end");
  }

  // X labels (4 max) - MM-DD
  const labelCount = Math.min(4, points.length);
  for(let i=0;i<labelCount;i++){
    const idx = Math.round(i*(points.length-1)/(labelCount-1 || 1));
    const x = xAt(idx);
    const d = points[idx].date || "";
    const short = d.length >= 10 ? d.slice(5) : d;

    const safeX = Math.max(padL + 20, Math.min(W - padR - 20, x));
    addText(svgLabels, safeX, H-20, short, 12, "rgba(111,127,150,1)", "middle");
    addLine(svgGrid, x, padT, x, padT+plotH, "rgba(120,140,165,.12)", 1);
  }

  const pts = points.map((p,i)=>({x:xAt(i), y:yAt(p.value)}));
  const lineD = smoothPath(pts);
  pathLine.setAttribute("d", lineD);

  const lastX = pts[pts.length-1].x;
  const firstX = pts[0].x;
  const bottomY = padT + plotH;
  const areaD = `${lineD} L ${lastX} ${bottomY} L ${firstX} ${bottomY} Z`;
  pathArea.setAttribute("d", areaD);

  dot.setAttribute("cx", String(lastX));
  dot.setAttribute("cy", String(pts[pts.length-1].y));
}

/* ====== Header + stats ====== */
function updateHeaderUI(allPoints){
  const last = allPoints[allPoints.length-1];
  const prev = allPoints.length >= 2 ? allPoints[allPoints.length-2] : null;

  elMain.textContent = `1 VAPECOIN = ${fmtUSD(last.value)}`;
  elSub.textContent = "Valor oficial del dÃ­a â€¢ USD";

  // % vs ayer (chip)
  if(prev){
    const ch = pct(prev.value, last.value);
    const up = ch >= 0;
    elChip.style.display = "inline-flex";
    elChipT.textContent = `${up ? "â¬†ï¸" : "â¬‡ï¸"} ${up ? "+" : ""}${ch.toFixed(2)}% vs ayer`;
  }else{
    elChip.style.display = "none";
  }

  // Ãšltima variaciÃ³n por fecha
  const lastDate = parseDate(last.date);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dd = daysBetween(lastDate, today);
  if(dd === 0) elLast.textContent = "Ãšltima variaciÃ³n: hoy";
  else if(dd === 1) elLast.textContent = "Ãšltima variaciÃ³n: hace 1 dÃ­a";
  else elLast.textContent = `Ãšltima variaciÃ³n: hace ${dd} dÃ­as`;

  // Tendencia semanal (basada en hoy vs ayer) + aclaraciÃ³n simulaciÃ³n
  let trendText = "Tendencia semanal: âž– Estable";
  if(prev){
    const diffPct = pct(prev.value, last.value);
    if(diffPct > 0.05) trendText = "Tendencia semanal: ðŸ“ˆ Alcista";
    else if(diffPct < -0.05) trendText = "Tendencia semanal: ðŸ“‰ Bajista";
  }
  elNote.textContent = `${trendText} â€¢ MÃ©tricas internas simuladas segÃºn historial`;

  // Stats simuladas (basadas en historial + parÃ¡metros internos)
  const price = last.value;

  let volUsd = 250;
  if(prev){
    const absChange = Math.abs(last.value - prev.value);
    volUsd = Math.max(250, absChange * VOLUME_FACTOR);
  }
  const volVC = volUsd / price;

  const mcap = price * INTERNAL_SUPPLY;
  const liq  = mcap * LIQUIDITY_PCT;

  elVol.textContent  = fmtUSD0(volUsd);
  elVolS.textContent = `${Math.round(volVC).toLocaleString("en-US")} VAPECOIN`;

  elMcap.textContent = fmtUSD0(mcap);
  elLiq.textContent  = fmtUSD0(liq);
}

/* ====== Load ====== */
async function loadAll(){
  cfg = await (await fetch(RATE_URL, {cache:"no-store"})).json();
  history = await (await fetch(HISTORY_URL, {cache:"no-store"})).json();

  history = (history || [])
    .filter(x => x && x.date && typeof x.value === "number")
    .sort((a,b) => String(a.date).localeCompare(String(b.date)));

  elLabel.textContent = cfg.label || "Valor de canje interno (oficial)";
  elUpd.textContent   = cfg.updated_at || "â€”";

  if(history.length === 0){
    elMain.textContent = "â€”";
    elSub.textContent  = "Valor oficial del dÃ­a â€¢ USD";
    elChip.style.display = "none";
    elLast.textContent = "Ãšltima variaciÃ³n: â€”";
    elNote.textContent = "â€”";
    drawChart([]);
    return;
  }

  updateHeaderUI(history);
  drawChart(sliceForRange(history));
}

/* ====== Tabs ====== */
function hookTabs(){
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      currentRange = tab.dataset.range;
      drawChart(sliceForRange(history));
    };
  });
}
hookTabs();
loadAll();
</script>
</body>
</html>
