<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VAPECOIN â€¢ Valor de Canje</title>

<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:transparent;}
  .wrap{display:flex;justify-content:center;padding:14px;}
  .card{
    width:100%;
    max-width:680px; /* ~30% menos horizontal */
    background:#fff;
    border-radius:18px;
    border:1px solid #e9eef5;
    box-shadow:0 10px 24px rgba(0,0,0,.10);
    overflow:hidden;
  }
  .top{
    background:linear-gradient(135deg,#0b76ff 0%,#08338f 100%);
    color:#fff;
    padding:16px;
    display:flex;
    align-items:center;
    gap:14px;
  }
  .logo{
    width:52px;height:52px;border-radius:50%;
    background:rgba(0,0,0,.25);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:26px;
    flex:0 0 auto;
  }
  .title{font-weight:900;font-size:20px;line-height:1.1;}
  .subtitle{font-size:13px;opacity:.9;margin-top:4px;}
  .price{margin-left:auto;text-align:right;}
  .price-main{font-weight:900;font-size:20px;}
  .price-base{font-size:13px;opacity:.92;margin-top:6px;}

  .mid{padding:14px 16px;}
  .tabs{display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
  .tab{
    padding:6px 12px;border-radius:999px;
    background:#eef2f7;color:#607089;
    font-weight:800;font-size:12px;
    cursor:pointer;user-select:none;
  }
  .tab.active{background:#0b76ff;color:#fff;}

  .chart{
    background:#f6f8fc;
    border:1px solid #e9eef5;
    border-radius:16px;
    padding:10px;
  }
  svg{width:100%;height:210px;display:block;}

  .footer{padding:12px 16px 14px;font-size:12px;color:#6b778c;}
  .footer strong{color:#2b3445;}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="top">
      <div class="logo">V</div>

      <div>
        <div class="title">VAPECOIN</div>
        <div class="subtitle" id="label">Valor de canje interno (oficial)</div>
      </div>

      <div class="price">
        <div class="price-main" id="mainPrice">â€”</div>
        <div class="price-base" id="basePrice">Valor oficial del dÃ­a â€¢ USD</div>
        <div class="price-base" id="dayChange">â€”</div>
        <div class="price-base" id="lastUpdate">Ãšltima variaciÃ³n: â€”</div>
      </div>
    </div>

    <div class="mid">
      <div class="tabs">
        <div class="tab active" data-range="24H">24H</div>
        <div class="tab" data-range="7D">7D</div>
        <div class="tab" data-range="1M">1M</div>
        <div class="tab" data-range="1Y">1Y</div>
        <div class="tab" data-range="MAX">MAX</div>
      </div>

      <div class="chart">
        <svg id="svg" viewBox="0 0 960 210" preserveAspectRatio="none">
          <g id="grid"></g>
          <g id="labels"></g>

          <path id="area" fill="rgba(11,118,255,.16)"></path>
          <path id="line" fill="none" stroke="#0b76ff" stroke-width="3.5"></path>
          <circle id="dot" r="5" fill="#0b76ff"></circle>
        </svg>
      </div>
    </div>

    <div class="footer">
      <div><strong>*</strong> <span id="note">â€”</span></div>
      <div style="margin-top:6px">Actualizado: <span id="updatedAt">â€”</span></div>
    </div>

  </div>
</div>

<script>
const RATE_URL = "https://peruvapea-svg.github.io/vapecoin-widget/vapecoin-rate.json";
const HISTORY_URL = "https://peruvapea-svg.github.io/vapecoin-widget/history.json";

let currentRange = "7D"; // en tu captura estabas en 7D, lo dejo como default
let history = [];
let cfg = null;

const elLabel = document.getElementById("label");
const elMain  = document.getElementById("mainPrice");
const elBase  = document.getElementById("basePrice");
const elDay   = document.getElementById("dayChange");
const elLast  = document.getElementById("lastUpdate");
const elUpd   = document.getElementById("updatedAt");
const elNote  = document.getElementById("note");

const svgGrid   = document.getElementById("grid");
const svgLabels = document.getElementById("labels");
const pathLine  = document.getElementById("line");
const pathArea  = document.getElementById("area");
const dot       = document.getElementById("dot");

function fmtUSD(v){
  return new Intl.NumberFormat("en-US",{
    style:"currency",
    currency:"USD",
    maximumFractionDigits:6
  }).format(v);
}
function pct(from, to){
  if(!from || from === 0) return 0;
  return ((to - from) / from) * 100;
}
function parseDate(s){
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
}
function daysBetween(a,b){
  const ms = 24*60*60*1000;
  return Math.round((b - a) / ms);
}
function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

function addText(parent, x, y, text, size=12, color="#7a889e", anchor="start"){
  const t = document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x", x);
  t.setAttribute("y", y);
  t.setAttribute("fill", color);
  t.setAttribute("font-size", String(size));
  t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Arial");
  t.setAttribute("text-anchor", anchor);
  t.textContent = text;
  parent.appendChild(t);
}
function addLine(parent, x1,y1,x2,y2, color="rgba(120,140,165,.35)", width=1){
  const l = document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1", x1); l.setAttribute("y1", y1);
  l.setAttribute("x2", x2); l.setAttribute("y2", y2);
  l.setAttribute("stroke", color);
  l.setAttribute("stroke-width", String(width));
  parent.appendChild(l);
}

function sliceForRange(data){
  if(data.length === 0) return data;

  if(currentRange === "24H"){
    // histÃ³rico diario => 24H muestra 2 puntos (hoy vs ayer)
    return data.slice(-2);
  }
  if(currentRange === "7D") return data.slice(-7);
  if(currentRange === "1M") return data.slice(-30);
  if(currentRange === "1Y") return data.slice(-365);
  return data;
}

function drawChart(points){
  const W = 960, H = 210;
  const padL = 64, padR = 22, padT = 14, padB = 52; // +espacio abajo para fechas
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const values = points.map(p => p.value);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const span = (maxV - minV) || (maxV*0.001) || 1;

  const xAt = (i) => padL + plotW * (i/(points.length-1 || 1));
  const yAt = (v) => padT + plotH - plotH * ((v - minV)/span);

  clearNode(svgGrid);
  clearNode(svgLabels);

  // grid + etiquetas Y (5)
  const levels = 5;
  for(let k=0;k<levels;k++){
    const t = k/(levels-1);
    const y = padT + plotH*t;
    addLine(svgGrid, padL, y, W-padR, y, "rgba(120,140,165,.28)", 1);

    const v = (maxV - span*t);
    addText(svgLabels, padL-10, y+4, fmtUSD(v), 12, "#6f7f96", "end");
  }

  // etiquetas X (mÃ¡x 4) y guÃ­as verticales suaves
  const labelCount = Math.min(4, points.length);
  for(let i=0;i<labelCount;i++){
    const idx = Math.round(i*(points.length-1)/(labelCount-1 || 1));
    const x = xAt(idx);

    const d = points[idx].date; // YYYY-MM-DD
    const short = d.slice(5);   // MM-DD

    // evita corte por bordes
    const safeX = Math.max(padL + 18, Math.min(W - padR - 18, x));

    addText(svgLabels, safeX, H-16, short, 12, "#6f7f96", "middle");
    addLine(svgGrid, x, padT, x, padT+plotH, "rgba(120,140,165,.16)", 1);
  }

  // line path
  let d = "";
  for(let i=0;i<points.length;i++){
    const x = xAt(i);
    const y = yAt(points[i].value);
    d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
  }
  pathLine.setAttribute("d", d);

  // area
  const lastX = xAt(points.length-1);
  const firstX = xAt(0);
  const areaD = d + ` L ${lastX} ${padT+plotH} L ${firstX} ${padT+plotH} Z`;
  pathArea.setAttribute("d", areaD);

  // last dot
  const lastY = yAt(points[points.length-1].value);
  dot.setAttribute("cx", String(lastX));
  dot.setAttribute("cy", String(lastY));
}

function updateHeaderUI(allPoints){
  const last = allPoints[allPoints.length-1];
  const prev = allPoints.length >= 2 ? allPoints[allPoints.length-2] : null;

  elMain.textContent = `1 VAPECOIN = ${fmtUSD(last.value)}`;
  elBase.textContent = "Valor oficial del dÃ­a â€¢ USD";

  // % vs ayer
  if(prev){
    const ch = pct(prev.value, last.value);
    const arrow = ch >= 0 ? "â¬†ï¸" : "â¬‡ï¸";
    const sign = ch >= 0 ? "+" : "";
    elDay.textContent = `${arrow} ${sign}${ch.toFixed(2)}% vs ayer`;
  }else{
    elDay.textContent = "â€”";
  }

  // Ãšltima variaciÃ³n (por fecha del Ãºltimo punto)
  const lastDate = parseDate(last.date);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dd = daysBetween(lastDate, today);
  if(dd === 0) elLast.textContent = "Ãšltima variaciÃ³n: hoy";
  else if(dd === 1) elLast.textContent = "Ãšltima variaciÃ³n: hace 1 dÃ­a";
  else elLast.textContent = `Ãšltima variaciÃ³n: hace ${dd} dÃ­as`;

  // Tendencia semanal (basada en comportamiento REAL: hoy vs ayer)
  // Zona neutra Â±0.05%
  if(prev){
    const diffPct = pct(prev.value, last.value);
    if(diffPct > 0.05) elNote.textContent = "Tendencia semanal: ðŸ“ˆ Alcista";
    else if(diffPct < -0.05) elNote.textContent = "Tendencia semanal: ðŸ“‰ Bajista";
    else elNote.textContent = "Tendencia semanal: âž– Estable";
  }else{
    elNote.textContent = "Tendencia semanal: âž– Estable";
  }
}

async function loadAll(){
  cfg = await (await fetch(RATE_URL, {cache:"no-store"})).json();
  history = await (await fetch(HISTORY_URL, {cache:"no-store"})).json();

  history = (history || [])
    .filter(x => x && x.date && typeof x.value === "number")
    .sort((a,b) => a.date.localeCompare(b.date));

  elLabel.textContent = cfg.label || "Valor de canje interno (oficial)";
  elUpd.textContent = cfg.updated_at || "â€”";

  if(history.length === 0){
    elMain.textContent = "â€”";
    elDay.textContent = "â€”";
    elLast.textContent = "â€”";
    elNote.textContent = "â€”";
    return;
  }

  updateHeaderUI(history);

  const slice = sliceForRange(history);
  // Si por alguna razÃ³n el rango tiene 1 punto, dibuja con 2 (para que el SVG no colapse)
  if(slice.length >= 2) drawChart(slice);
  else drawChart(history.slice(-2));
}

function hookTabs(){
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      currentRange = tab.dataset.range;

      const slice = sliceForRange(history);
      if(slice.length >= 2) drawChart(slice);
      else drawChart(history.slice(-2));
    };
  });
}

// set default active tab based on currentRange
function setDefaultTab(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.range === currentRange);
  });
}

hookTabs();
setDefaultTab();
loadAll();
</script>
</body>
</html>
