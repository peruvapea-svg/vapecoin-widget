<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VAPECOIN • Valor de Canje</title>

<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:transparent;}
  .wrap{display:flex;justify-content:center;padding:14px;}
  .card{width:100%;max-width:960px;background:#fff;border-radius:18px;border:1px solid #e9eef5;box-shadow:0 10px 24px rgba(0,0,0,.10);overflow:hidden;}
  .top{background:linear-gradient(135deg,#0b76ff 0%,#08338f 100%);color:#fff;padding:18px;display:flex;align-items:center;gap:14px;}
  .logo{width:54px;height:54px;border-radius:50%;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;}
  .title{font-weight:900;font-size:22px;line-height:1.1;}
  .subtitle{font-size:14px;opacity:.9;margin-top:4px;}
  .price{margin-left:auto;text-align:right;}
  .price-main{font-weight:900;font-size:22px;}
  .price-base{font-size:14px;opacity:.92;margin-top:6px;}

  .mid{padding:16px 18px;}
  .tabs{display:flex;justify-content:flex-end;gap:10px;margin-bottom:10px;}
  .tab{padding:6px 14px;border-radius:999px;background:#eef2f7;color:#607089;font-weight:800;font-size:12px;cursor:pointer;user-select:none;}
  .tab.active{background:#0b76ff;color:#fff;}

  .chart{background:#f6f8fc;border:1px solid #e9eef5;border-radius:16px;padding:10px;}
  svg{width:100%;height:260px;display:block;}

  .footer{padding:12px 18px 16px;font-size:12px;color:#6b778c;}
  .footer strong{color:#2b3445;}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="top">
      <div class="logo">V</div>
      <div>
        <div class="title">VAPECOIN</div>
        <div class="subtitle" id="label">Valor de canje interno (oficial)</div>
      </div>

      <div class="price">
        <div class="price-main" id="mainPrice">—</div>
        <div class="price-base" id="basePrice">—</div>
        <div class="price-base" id="dayChange">—</div>
        <div class="price-base" id="lastUpdate">Última variación: —</div>
      </div>
    </div>

    <div class="mid">
      <div class="tabs">
        <div class="tab active" data-range="24H">24H</div>
        <div class="tab" data-range="7D">7D</div>
        <div class="tab" data-range="1M">1M</div>
        <div class="tab" data-range="1Y">1Y</div>
        <div class="tab" data-range="MAX">MAX</div>
      </div>

      <div class="chart">
        <svg id="svg" viewBox="0 0 960 260" preserveAspectRatio="none">
          <!-- grid -->
          <g id="grid"></g>
          <!-- axis labels -->
          <g id="labels"></g>
          <!-- area + line -->
          <path id="area" fill="rgba(11,118,255,.16)"></path>
          <path id="line" fill="none" stroke="#0b76ff" stroke-width="3.5"></path>
          <circle id="dot" r="5" fill="#0b76ff"></circle>
        </svg>
      </div>
    </div>

    <div class="footer">
      <div><strong>*</strong> <span id="note">No es precio de mercado. Valor interno de canje válido solo en PERUVAPEA.</span></div>
      <div style="margin-top:6px">Actualizado: <span id="updatedAt">—</span></div>
    </div>

  </div>
</div>

<script>
const RATE_URL = "https://peruvapea-svg.github.io/vapecoin-widget/vapecoin-rate.json";
const HISTORY_URL = "https://peruvapea-svg.github.io/vapecoin-widget/history.json";

let currentRange = "24H";
let history = []; // [{date, value}]
let cfg = null;

const elLabel = document.getElementById("label");
const elMain  = document.getElementById("mainPrice");
const elBase  = document.getElementById("basePrice");
const elDay   = document.getElementById("dayChange");
const elLast  = document.getElementById("lastUpdate");
const elUpd   = document.getElementById("updatedAt");
const elNote  = document.getElementById("note");

const svgGrid   = document.getElementById("grid");
const svgLabels = document.getElementById("labels");
const pathLine  = document.getElementById("line");
const pathArea  = document.getElementById("area");
const dot       = document.getElementById("dot");

function fmtUSD(v){
  return new Intl.NumberFormat("en-US",{
    style:"currency",
    currency:"USD",
    maximumFractionDigits:6
  }).format(v);
}

function pct(from, to){
  if(!from || from === 0) return 0;
  return ((to - from) / from) * 100;
}

function parseDate(s){
  // expects YYYY-MM-DD
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
}

function daysBetween(a,b){
  const ms = 24*60*60*1000;
  return Math.round((b - a) / ms);
}

function sliceForRange(data){
  if(data.length === 0) return data;

  if(currentRange === "24H"){
    // we only have daily points; show last 2 days for "24H"
    return data.slice(-2);
  }
  if(currentRange === "7D") return data.slice(-7);
  if(currentRange === "1M") return data.slice(-30);
  if(currentRange === "1Y") return data.slice(-365);
  return data; // MAX
}

function clearNode(node){
  while(node.firstChild) node.removeChild(node.firstChild);
}

function addText(parent, x, y, text, size=12, color="#7a889e", anchor="start"){
  const t = document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x", x);
  t.setAttribute("y", y);
  t.setAttribute("fill", color);
  t.setAttribute("font-size", String(size));
  t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Arial");
  t.setAttribute("text-anchor", anchor);
  t.textContent = text;
  parent.appendChild(t);
}

function addLine(parent, x1,y1,x2,y2, color="rgba(120,140,165,.35)", width=1){
  const l = document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1", x1); l.setAttribute("y1", y1);
  l.setAttribute("x2", x2); l.setAttribute("y2", y2);
  l.setAttribute("stroke", color);
  l.setAttribute("stroke-width", String(width));
  parent.appendChild(l);
}

function drawChart(points){
  // SVG coords
  const W = 960, H = 260;
  const padL = 64, padR = 18, padT = 14, padB = 38;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const values = points.map(p => p.value);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const span = (maxV - minV) || (maxV*0.001) || 1;

  const xAt = (i) => padL + plotW * (i/(points.length-1 || 1));
  const yAt = (v) => padT + plotH - plotH * ((v - minV)/span);

  // grid + Y labels (5 levels)
  clearNode(svgGrid);
  clearNode(svgLabels);

  const levels = 5;
  for(let k=0;k<levels;k++){
    const t = k/(levels-1);
    const y = padT + plotH*t;
    addLine(svgGrid, padL, y, W-padR, y);
    const v = (maxV - span*t);
    addText(svgLabels, padL-10, y+4, fmtUSD(v), 12, "#6f7f96", "end");
  }

  // X labels: show up to 4 labels evenly spaced
  const labelCount = Math.min(4, points.length);
  for(let i=0;i<labelCount;i++){
    const idx = Math.round(i*(points.length-1)/(labelCount-1 || 1));
    const x = xAt(idx);
    const d = points[idx].date;
    addText(svgLabels, x, H-14, d, 12, "#6f7f96", "middle");
    // vertical guide (light)
    addLine(svgGrid, x, padT, x, padT+plotH, "rgba(120,140,165,.20)", 1);
  }

  // line path
  let d = "";
  for(let i=0;i<points.length;i++){
    const x = xAt(i);
    const y = yAt(points[i].value);
    d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
  }
  pathLine.setAttribute("d", d);

  // area path
  const lastX = xAt(points.length-1);
  const firstX = xAt(0);
  const lastY = yAt(points[points.length-1].value);
  const areaD = d + ` L ${lastX} ${padT+plotH} L ${firstX} ${padT+plotH} Z`;
  pathArea.setAttribute("d", areaD);

  // last dot
  dot.setAttribute("cx", String(lastX));
  dot.setAttribute("cy", String(lastY));
}

function updateHeaderUI(allPoints){
  // last value = official "today"
  const last = allPoints[allPoints.length-1];
  const prev = allPoints.length >= 2 ? allPoints[allPoints.length-2] : null;

  elMain.textContent = `1 VAPECOIN = ${fmtUSD(last.value)}`;
  elBase.textContent = `Valor oficial del día • USD`;

  // change vs previous day
  if(prev){
    const ch = pct(prev.value, last.value);
    const arrow = ch >= 0 ? "⬆️" : "⬇️";
    const sign = ch >= 0 ? "+" : "";
    elDay.textContent = `${arrow} ${sign}${ch.toFixed(2)}% vs ayer`;
  }else{
    elDay.textContent = "—";
  }

  // "última variación": días desde último cambio (según fechas del histórico)
  const lastDate = parseDate(last.date);
  const now = new Date();
  const dd = daysBetween(lastDate, new Date(now.getFullYear(), now.getMonth(), now.getDate()));
  if(dd === 0) elLast.textContent = "Última variación: hoy";
  else if(dd === 1) elLast.textContent = "Última variación: hace 1 día";
  else elLast.textContent = `Última variación: hace ${dd} días`;
}

async function loadAll(){
  cfg = await (await fetch(RATE_URL, {cache:"no-store"})).json();
  history = await (await fetch(HISTORY_URL, {cache:"no-store"})).json();

  // normalize + sort
  history = (history || [])
    .filter(x => x && x.date && typeof x.value === "number")
    .sort((a,b) => a.date.localeCompare(b.date));

  // header text
  elLabel.textContent = cfg.label || "Valor de canje interno (oficial)";
  elUpd.textContent = cfg.updated_at || "—";
  elNote.textContent = cfg.note || "No es precio de mercado. Valor interno de canje válido solo en PERUVAPEA.";

  if(history.length === 0){
    elMain.textContent = "—";
    elBase.textContent = "—";
    elDay.textContent = "—";
    elLast.textContent = "—";
    return;
  }

  updateHeaderUI(history);

  // draw according to current range
  const slice = sliceForRange(history);
  drawChart(slice);
}

function hookTabs(){
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      currentRange = tab.dataset.range;

      const slice = sliceForRange(history);
      if(slice.length >= 2) drawChart(slice);
      else drawChart(history);
    };
  });
}

hookTabs();
loadAll();
</script>
</body>
</html>
